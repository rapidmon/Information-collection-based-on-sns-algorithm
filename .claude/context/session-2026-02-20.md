# Session Context — 2026-02-20

> 이 파일을 새 세션에서 Claude에게 제공하면 이전 세션의 맥락을 이어서 작업할 수 있습니다.

---

## 프로젝트 개요

SNS Tech Briefing — 여러 SNS(Twitter/X, Threads, LinkedIn, DCInside)에서 기술 뉴스를 자동 수집하고, OpenAI로 필터링/요약/분류한 뒤, 이메일 브리핑을 생성하는 시스템.

### 기술 스택
- Python 3.12, FastAPI, APScheduler
- Firebase Firestore (클라우드 DB)
- Playwright + CDP (Chrome DevTools Protocol, port 9222) — 브라우저 자동화
- OpenAI API: gpt-4o-mini (필터링), gpt-4o (분류/통합)
- Tailwind CSS (CDN), Jinja2 템플릿
- Clean Architecture (domain → application → infrastructure → presentation)

### 핵심 아키텍처
- DI Container (Composition Root): `src/infrastructure/config/container.py`
- 4개 수집기: twitter, threads, linkedin, dcinside (모두 CDP 기반)
- AI 3단계 파이프라인: filter_and_summarize → categorize → deduplicate_and_merge
- 공유 CDP 모듈: `src/infrastructure/collectors/cdp.py`

---

## 이번 세션에서 수행한 작업

### 1. 코드 리팩토링 (커밋: 05d9e17)
- **삭제**: `browser_manager.py` (131줄, 미사용), `base.py` (BaseCollector ABC, 29줄), `application/dto/__init__.py` (빈 패키지)
- **추출**: 4개 수집기의 중복 CDP 연결 보일러플레이트 → `cdp.py` 공유 모듈 (53줄)
  - `cdp_connection()`: async context manager
  - `check_session()`: 세션 유효성 검증
- **중복제거**: `post_repo.py`의 3개 batch 패턴 → `_run_batch()` 공유 메서드
- `settings.py`에서 `BrowserConfig` 제거
- 결과: 3960→3711줄 (-249), 40→39파일

### 2. Firestore 복합 인덱스 이슈 해결
- `/api/posts/search` 500 에러 → `where()` + `order_by()` 조합에 복합 인덱스 필요
- 사용자가 Firebase Console에서 생성한 인덱스:
  - posts: `summary` + `collected_at` (get_unprocessed용)
  - posts: `is_relevant` + `collected_at` (search용)
  - posts: `is_relevant` + `source` + `collected_at` (소스 필터 search용)
  - posts: `is_relevant` + `briefed_at` + `collected_at` (get_unbriefed용)
  - collection_runs: `source` + `status` + `completed_at`
  - collection_runs: `source` + `started_at`

### 3. AI 프롬프트 개선 (커밋: 302af93)
- `SYSTEM_PROMPT`: 중요도 차등 부여 강화, 구체적 점수 기준 예시
- `FILTER_AND_SUMMARIZE`: 관련 없음 기준 구체화 (일상, 밈, 자기홍보 등)
- `CATEGORIZE`: 차등 점수 예시 5개 추가, 배치 내 상대 비교 지시, **키워드 3-5개 추출 추가**
- `DEDUPLICATE_AND_MERGE`: 카테고리 수 오류 수정 (6개→7개)

### 4. 키워드 추출 파이프라인 추가 (커밋: e4eab2f)
- `Post` 엔티티: `keywords: list[str]` 필드 추가
- `CategoryResult` dataclass: `keywords: list[str] | None` 필드 추가
- `OpenAIProcessor.categorize()`: 응답에서 keywords 파싱
- `process_posts.py`: `post.keywords = cr.keywords` 저장
- `post_repo.py`: `_post_to_dict`, `_post_from_doc`, `update()` 모두 keywords 포함
- Firestore 인덱스 불필요 (keywords 필드로 where 쿼리 안 함)

### 5. 플립 카드 UI (커밋: 302af93)
- `posts.html` 완전 재작성
- **앞면**: 소스 배지 + 중요도 점수 + 키워드 태그(크기/색상 차등) + 뒤집기 힌트 아이콘
- **뒷면**: 카테고리 태그 + 요약 본문(스크롤 가능) + "원문 보기" 링크 버튼
- CSS 3D transform (`perspective`, `rotateY`, `backface-visibility`)
- 모바일 반응형: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3`
- `event.stopPropagation()`으로 링크 클릭 시 카드 뒤집힘 방지

### 6. 트위터 수집 타임아웃 수정 (커밋: 4e3d45d)
- x.com이 `networkidle` 상태에 도달 못하는 문제
- `wait_until="domcontentloaded"`, `timeout=60000`, 3초 명시적 대기로 변경

### 7. 문서 업데이트 (커밋: c9c0c7c)
- `docs/DESIGN.md` + 8개 feature docs에 `[NEW]` 주석으로 현재 구현 상태 반영

---

## 알려진 이슈 (미해결)

### 1. OpenAI API 동기 호출이 이벤트 루프 차단
- `openai_processor.py`의 `_call_api()`가 동기 `OpenAI().chat.completions.create()` 사용
- async 컨텍스트에서 호출하지만 `asyncio.to_thread()`로 감싸지 않음
- `/api/process/trigger` 호출 시 2분+ 블로킹 (응답은 결국 옴)
- 수정 방법: `_call_api` 내부를 `asyncio.to_thread()`로 감싸거나, AsyncOpenAI 클라이언트 사용

### 2. 기존 게시물에 키워드 없음
- 이미 AI 처리된 게시물은 `keywords: []` 상태
- `get_unprocessed()`는 `summary == None`으로 필터하므로 기존 게시물 안 잡힘
- 새로 수집/처리되는 게시물부터 키워드가 붙음
- 원하면 재분류 스크립트 필요 (API 비용 발생)

### 3. 요약 한글 인코딩 깨짐
- API 응답에서 한글 summary가 간헐적으로 garbled — 원인 미조사

---

## 주요 파일 경로 맵

```
src/
├── domain/
│   ├── entities/post.py          # Post 도메인 엔티티 (keywords 필드 포함)
│   ├── services/ai_processor.py  # AIProcessor Protocol + FilterResult/CategoryResult/MergedTopic
│   └── repositories/             # Repository Protocol 정의
├── application/
│   └── use_cases/
│       ├── process_posts.py      # AI 처리 파이프라인 유즈케이스
│       ├── collect_posts.py      # 수집 유즈케이스 (재시도 로직 포함)
│       └── scheduler.py          # APScheduler 작업 등록
├── infrastructure/
│   ├── ai/
│   │   ├── prompts.py            # GPT 프롬프트 템플릿 (SYSTEM, FILTER, CATEGORIZE, MERGE)
│   │   └── openai_processor.py   # OpenAI API 구현체
│   ├── collectors/
│   │   ├── cdp.py                # 공유 CDP 연결 모듈
│   │   ├── twitter_collector.py  # GraphQL 인터셉트 방식
│   │   ├── threads_collector.py  # DOM 파싱 방식
│   │   ├── linkedin_collector.py # DOM 파싱 방식
│   │   └── dcinside_collector.py # HTTP + DOM 하이브리드
│   ├── config/
│   │   ├── settings.py           # AppConfig (환경변수 기반)
│   │   └── container.py          # DI Container (Composition Root)
│   └── database/repositories/
│       ├── post_repo.py          # Firestore PostRepository (keywords 포함)
│       └── ...
└── presentation/
    └── web/
        ├── routes/
        │   ├── dashboard.py      # HTML 라우트 (/, /posts, /briefings, /status)
        │   └── api.py            # REST API (/api/collect, /api/process, /api/briefing)
        └── templates/
            ├── base.html         # 공통 레이아웃 (Tailwind CDN, nav)
            ├── dashboard.html    # 대시보드 메인
            ├── posts.html        # 게시물 탐색 (플립 카드 UI)
            ├── briefings.html    # 브리핑 아카이브
            └── status.html       # 시스템 상태
```

---

## 커밋 히스토리 (최신순)

```
db2fc11 Update Claude Code local settings
4e3d45d Fix twitter collector timeout by using domcontentloaded
302af93 Add flip card UI with keywords and improve AI prompts
e4eab2f Add keywords extraction to AI categorization pipeline
671fa68 Add Claude Code custom commands and settings
05d9e17 Refactor: remove dead code, extract CDP helper, deduplicate batch ops
c9c0c7c Update feature docs and DESIGN.md to reflect current implementation
bb4ebb0 Update README with detailed setup and execution guide
47b0b18 Track briefing status with briefed_at field
3804fa2 Delete irrelevant posts from Firestore after AI processing
1df5895 Change AI model, processing interval, and schedule
```

---

## GitHub Pages 대시보드 계획 (미구현)

`.claude/plans/bubbly-singing-puppy.md`에 상세 계획 있음.
Firebase JS SDK로 Firestore를 직접 읽는 정적 HTML 대시보드를 `docs/` 폴더에 만들어 GitHub Pages 배포.
사전 조건: Firebase 웹 앱 config 값 + Firestore 보안 규칙 읽기 공개 설정 필요.

---

## 사용자 선호/참고

- 모든 설명은 한국어로
- 커밋은 기능별로 분리
- `.claude/commands/`에 `/optimize`, `/refactoring` 커스텀 명령어 존재
- 프롬프트 개선 시 구체적 예시와 차등 점수 부여 강조
- UI는 Tailwind CSS 기반, 카드형 디자인 선호
